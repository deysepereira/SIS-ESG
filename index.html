<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA SIS-ESG | Registro de Demandas Blindado</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expondo funções para o escopo global do React
        window.Firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, arrayUnion, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .audit-trail { font-family: 'Courier New', monospace; font-size: 0.75rem; }
        
        .login-bg {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        /* Estilo para barras do gráfico */
        .bar-container { height: 180px; display: flex; align-items: flex-end; gap: 12px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; }
        .bar { width: 100%; max-width: 40px; border-radius: 4px 4px 0 0; transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .bar:hover { filter: brightness(1.1); }
        .tooltip { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .bar-wrapper:hover .tooltip { opacity: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuração Segura e Inicialização do Firebase ---
        // Em produção, estas variáveis viriam de variáveis de ambiente injetadas
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let db, auth;
        if (window.Firebase && firebaseConfig.apiKey) {
            const app = window.Firebase.initializeApp(firebaseConfig);
            db = window.Firebase.getFirestore(app);
            auth = window.Firebase.getAuth(app);
        }

        // --- Componentes UI ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const pascalName = name.replace(/(^\w|-\w)/g, (clear) => clear.replace('-', '').toUpperCase());
                    const iconDef = window.lucide.icons ? window.lucide.icons[pascalName] : null;
                    if (iconDef) {
                        const svg = window.lucide.createElement(iconDef);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', className);
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        // --- Login Seguro ---
        const LoginScreen = ({ onLogin, loading }) => {
            return (
                <div className="min-h-screen login-bg flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                        <div className="p-8 pb-6 text-center border-b border-slate-100">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-100 mb-4 text-emerald-600">
                                <Icon name="shield-check" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight">SIS-ESG Seguro</h1>
                            <p className="text-xs text-slate-500 mt-1 uppercase tracking-wider">Acesso Restrito & Auditado</p>
                        </div>
                        <div className="p-8 pt-6">
                            <button 
                                onClick={onLogin} 
                                disabled={loading}
                                className="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-4 rounded-lg shadow-lg hover:shadow-xl transition flex items-center justify-center gap-3 disabled:opacity-70"
                            >
                                {loading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="lock" />}
                                {loading ? "Estabelecendo Conexão Segura..." : "Autenticar no Sistema"}
                            </button>
                            <p className="mt-4 text-center text-xs text-slate-400">
                                Este sistema utiliza criptografia de ponta a ponta e registra todas as ações para fins de auditoria (ISO 27001).
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Aplicação Principal ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [demands, setDemands] = useState([]);
            const [currentDemand, setCurrentDemand] = useState(null);
            const [authLoading, setAuthLoading] = useState(false);
            const [listFilters, setListFilters] = useState({ status: 'Todos', project: 'Todos', startDate: '', endDate: '', search: '' });

            // 1. Inicialização e Autenticação Segura
            useEffect(() => {
                if (!auth) return;
                
                const initAuth = async () => {
                    setAuthLoading(true);
                    try {
                        // Prioriza token customizado se disponível (ambiente seguro), senão anônimo (teste)
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.Firebase.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await window.Firebase.signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Falha na autenticação:", error);
                        alert("Erro de segurança ao autenticar. Contate o administrador.");
                    } finally {
                        setAuthLoading(false);
                    }
                };

                initAuth();
                return window.Firebase.onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            // 2. Listener de Dados em Tempo Real (Firestore)
            useEffect(() => {
                if (!user || !db) return;

                const q = window.Firebase.collection(db, 'artifacts', appId, 'public', 'data', 'esg_demands');
                
                const unsubscribe = window.Firebase.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    data.sort((a, b) => new Date(b.entryDate) - new Date(a.entryDate));
                    setDemands(data);
                }, (error) => {
                    console.error("Acesso negado ou erro de conexão:", error);
                });

                return () => unsubscribe();
            }, [user]);

            // --- Handlers de Ação ---

            const handleSave = async (demand) => {
                if (!user) return;

                const cleanData = {
                    refNumber: String(demand.refNumber || '').trim(),
                    entryDate: demand.entryDate || new Date().toISOString().split('T')[0],
                    initialAssessment: String(demand.initialAssessment || ''),
                    technicalOpinion: String(demand.technicalOpinion || ''),
                    department: String(demand.department || 'Jurídico'),
                    project: String(demand.project || 'Não Identificado'),
                    status: String(demand.status || 'Pendente'),
                    assignee: String(demand.assignee || ''),
                    deadline: String(demand.deadline || ''),
                    value: parseFloat(demand.value) || 0,
                    approvedValue: parseFloat(demand.approvedValue) || 0,
                    evidenceLink: String(demand.evidenceLink || ''),
                    counterpartCompliance: String(demand.counterpartCompliance || ''),
                    finalDecision: String(demand.finalDecision || ''),
                    notes: String(demand.notes || ''),
                };

                const auditEntry = {
                    date: new Date().toISOString(), 
                    user: user.uid.substring(0, 8) + '...',
                    action: demand.id ? "Edição de Registro" : "Criação de Registro"
                };

                try {
                    const collectionRef = window.Firebase.collection(db, 'artifacts', appId, 'public', 'data', 'esg_demands');

                    if (demand.id) {
                        const docRef = window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'esg_demands', demand.id);
                        await window.Firebase.updateDoc(docRef, {
                            ...cleanData,
                            updatedAt: window.Firebase.serverTimestamp(), 
                            auditTrail: window.Firebase.arrayUnion(auditEntry)
                        });
                    } else {
                        await window.Firebase.addDoc(collectionRef, {
                            ...cleanData,
                            createdAt: window.Firebase.serverTimestamp(), 
                            updatedAt: window.Firebase.serverTimestamp(), 
                            auditTrail: [auditEntry]
                        });
                    }
                    setView('list');
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Erro de permissão ou dados inválidos.");
                }
            };

            const handleDelete = async (id) => {
                if (!user) return;
                if (confirm("ATENÇÃO: A exclusão apaga permanentemente as evidências de auditoria. Continuar?")) {
                    try {
                        await window.Firebase.deleteDoc(window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'esg_demands', id));
                    } catch (e) {
                        alert("Erro: Apenas Administradores podem excluir registros.");
                    }
                }
            };

            const exportPDF = (filteredData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.text("Relatório de Auditoria: Demandas ESG", 14, 22);
                doc.setFontSize(10); doc.text(`Extraído em: ${new Date().toLocaleString()} | ID Usuário: ${user.uid}`, 14, 28);
                doc.line(14, 32, 196, 32);

                const tableRows = filteredData.map(d => [
                    d.refNumber, d.entryDate.split('-').reverse().join('/'), 
                    d.project, d.status, formatCurrency(d.approvedValue), 
                    d.counterpartCompliance === 'Não' ? 'IRREGULAR' : 'OK'
                ]);

                doc.autoTable({
                    head: [["Ofício", "Data", "Projeto", "Status", "Valor Apr.", "Compliance"]],
                    body: tableRows,
                    startY: 35,
                    headStyles: { fillColor: [15, 23, 42] }, 
                    alternateRowStyles: { fillColor: [241, 245, 249] } 
                });
                doc.save(`auditoria_esg_${new Date().getTime()}.pdf`);
            };

            // --- Sub-componentes ---
            
            const Dashboard = () => {
                const [filters, setFilters] = useState({ startDate: '', endDate: '', project: 'Todos', status: 'Todos' });
                const projects = useMemo(() => ['Todos', ...new Set(demands.map(d => d.project || 'Não Identificado'))], [demands]);

                const filtered = useMemo(() => demands.filter(d => {
                    const date = d.entryDate;
                    const matchStart = !filters.startDate || date >= filters.startDate;
                    const matchEnd = !filters.endDate || date <= filters.endDate;
                    const matchProj = filters.project === 'Todos' || d.project === filters.project;
                    const matchStatus = filters.status === 'Todos' || d.status === filters.status;
                    return matchStart && matchEnd && matchProj && matchStatus;
                }), [demands, filters]);

                // Cálculo para Gráfico Mensal
                const monthlyData = useMemo(() => {
                    const data = {};
                    filtered.forEach(d => {
                        const m = d.entryDate.substring(0, 7);
                        if(!data[m]) data[m] = { val: 0, count: 0 };
                        data[m].val += d.approvedValue || 0;
                        data[m].count++;
                    });
                    return Object.keys(data).sort().map(k => ({ month: k, ...data[k] }));
                }, [filtered]);
                const maxVal = Math.max(...monthlyData.map(d => d.val), 1);

                // Cálculo Ranking Financeiro de Projetos (Novo)
                const projectRanking = useMemo(() => {
                    const ranking = {};
                    filtered.forEach(d => {
                        const proj = d.project || 'Não Identificado';
                        if (!ranking[proj]) ranking[proj] = 0;
                        ranking[proj] += (d.approvedValue || 0);
                    });
                    return Object.entries(ranking)
                        .sort(([,a], [,b]) => b - a)
                        .map(([project, value]) => ({ project, value }));
                }, [filtered]);

                const irregulars = filtered.filter(d => d.counterpartCompliance === 'Não');

                return (
                    <div className="space-y-6 animate-fade-in">
                        {/* Filtros */}
                        <div className="bg-white p-4 rounded border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label className="text-xs font-bold text-slate-500">Início</label><input type="date" className="w-full border p-2 rounded text-sm" onChange={e=>setFilters({...filters, startDate: e.target.value})}/></div>
                            <div><label className="text-xs font-bold text-slate-500">Fim</label><input type="date" className="w-full border p-2 rounded text-sm" onChange={e=>setFilters({...filters, endDate: e.target.value})}/></div>
                            <div><label className="text-xs font-bold text-slate-500">Projeto</label><select className="w-full border p-2 rounded text-sm" onChange={e=>setFilters({...filters, project: e.target.value})}>{projects.map(p=><option key={p}>{p}</option>)}</select></div>
                            <div><label className="text-xs font-bold text-slate-500">Status</label><select className="w-full border p-2 rounded text-sm" onChange={e=>setFilters({...filters, status: e.target.value})}><option>Todos</option><option>Pendente</option><option>Em execução</option><option>Concluída</option></select></div>
                        </div>

                        {/* KPIs */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-6 border-l-4 border-slate-800 shadow-sm">
                                <p className="text-slate-500 text-xs font-bold uppercase">Total Filtrado</p>
                                <p className="text-3xl font-bold">{filtered.length}</p>
                            </div>
                            <div className="bg-white p-6 border-l-4 border-emerald-600 shadow-sm">
                                <p className="text-slate-500 text-xs font-bold uppercase">Aprovado (R$)</p>
                                <p className="text-3xl font-bold">{formatCurrency(filtered.reduce((a,b)=>a+b.approvedValue,0))}</p>
                            </div>
                            <div className={`p-6 border-l-4 shadow-sm ${irregulars.length > 0 ? 'bg-red-50 border-red-600' : 'bg-white border-green-600'}`}>
                                <p className="text-slate-500 text-xs font-bold uppercase flex items-center gap-2">
                                    {irregulars.length > 0 && <Icon name="alert-triangle" size={16} className="text-red-600"/>} Risco Compliance
                                </p>
                                <p className={`text-3xl font-bold ${irregulars.length > 0 ? 'text-red-700' : 'text-slate-800'}`}>{irregulars.length}</p>
                            </div>
                        </div>

                        {/* Layout Inferior: Gráfico e Ranking Lado a Lado */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* Gráfico */}
                            <div className="bg-white p-6 rounded shadow-sm flex flex-col">
                                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <Icon name="bar-chart-2" className="text-blue-600"/> Evolução Mensal (Volume)
                                </h3>
                                {monthlyData.length > 0 ? (
                                    <div className="bar-container border-b border-slate-200 mt-auto">
                                        {monthlyData.map(d => (
                                            <div key={d.month} className="bar-wrapper group">
                                                <div className="tooltip absolute -top-10 bg-slate-800 text-white text-xs p-2 rounded z-10">
                                                    {formatCurrency(d.val)} <br/> ({d.count} demandas)
                                                </div>
                                                <div className="bar bg-emerald-500 group-hover:bg-emerald-600" style={{height: `${(d.val/maxVal)*100}%`, minHeight: '4px'}}></div>
                                                <div className="text-[10px] text-slate-500 mt-2">{d.month}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : <p className="text-slate-400 text-sm text-center py-8">Sem dados para exibir.</p>}
                            </div>

                            {/* Ranking Financeiro (Novo Módulo) */}
                            <div className="bg-white p-6 rounded shadow-sm">
                                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <Icon name="trending-up" className="text-emerald-600"/> Ranking Financeiro por Projeto
                                </h3>
                                <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                                    {projectRanking.length > 0 ? projectRanking.map((item, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded border border-slate-100 hover:bg-slate-100 transition">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${idx < 3 ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-200 text-slate-600'}`}>
                                                    {idx + 1}
                                                </div>
                                                <span className="text-sm font-medium text-slate-700 truncate max-w-[150px] md:max-w-[200px]" title={item.project}>{item.project}</span>
                                            </div>
                                            <span className="text-sm font-bold text-emerald-700">{formatCurrency(item.value)}</span>
                                        </div>
                                    )) : (
                                        <p className="text-slate-400 text-sm text-center py-8">Nenhum projeto com aporte registrado.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                )
            };

            const DemandList = () => {
                // Filtros da Lista (Cópia da lógica para brevidade, mas independente)
                const projects = useMemo(() => ['Todos', ...new Set(demands.map(d => d.project || 'Não Identificado'))], [demands]);
                const filtered = useMemo(() => demands.filter(d => {
                    const matchSearch = d.refNumber.toLowerCase().includes(listFilters.search.toLowerCase());
                    const matchProj = listFilters.project === 'Todos' || d.project === listFilters.project;
                    const matchStatus = listFilters.status === 'Todos' || d.status === listFilters.status;
                    const matchDateStart = !listFilters.startDate || d.entryDate >= listFilters.startDate;
                    const matchDateEnd = !listFilters.endDate || d.entryDate <= listFilters.endDate;
                    return matchSearch && matchProj && matchStatus && matchDateStart && matchDateEnd;
                }), [demands, listFilters]);

                return (
                    <div className="bg-white p-6 rounded shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                            <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="table" /> Registros Auditáveis</h2>
                            <div className="flex gap-2">
                                <button onClick={() => exportPDF(filtered)} className="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-sm flex items-center gap-2"><Icon name="file-text" size={16}/> Relatório PDF</button>
                                <button onClick={() => { setCurrentDemand({}); setView('form'); }} className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm flex items-center gap-2"><Icon name="plus" size={16}/> Novo</button>
                            </div>
                        </div>
                        {/* Filtros Lista */}
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-2 bg-slate-50 p-3 rounded text-sm">
                            <input placeholder="Buscar..." className="border p-2 rounded" onChange={e=>setListFilters({...listFilters, search: e.target.value})}/>
                            <select className="border p-2 rounded" onChange={e=>setListFilters({...listFilters, project: e.target.value})}>{projects.map(p=><option key={p}>{p}</option>)}</select>
                            <select className="border p-2 rounded" onChange={e=>setListFilters({...listFilters, status: e.target.value})}><option>Todos</option><option>Pendente</option><option>Concluída</option></select>
                            <input type="date" className="border p-2 rounded" onChange={e=>setListFilters({...listFilters, startDate: e.target.value})}/>
                            <input type="date" className="border p-2 rounded" onChange={e=>setListFilters({...listFilters, endDate: e.target.value})}/>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-slate-100 text-xs uppercase font-bold text-slate-700">
                                    <tr><th className="p-3">Ref</th><th className="p-3">Data</th><th className="p-3">Projeto</th><th className="p-3">Valor Apr.</th><th className="p-3">Status</th><th className="p-3 text-right">Ações</th></tr>
                                </thead>
                                <tbody>
                                    {filtered.map(d => (
                                        <tr key={d.id} className="border-b hover:bg-slate-50">
                                            <td className="p-3 font-mono">{d.refNumber}</td>
                                            <td className="p-3">{d.entryDate.split('-').reverse().join('/')}</td>
                                            <td className="p-3 max-w-[150px] truncate">{d.project}</td>
                                            <td className="p-3 text-emerald-700 font-bold">{formatCurrency(d.approvedValue)}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${d.status === 'Concluída' ? 'bg-emerald-100 text-emerald-800' : 'bg-yellow-100 text-yellow-800'}`}>{d.status}</span></td>
                                            <td className="p-3 text-right">
                                                <button onClick={() => { setCurrentDemand(d); setView('form'); }} className="text-blue-600 hover:text-blue-800 mx-1"><Icon name="edit-2" size={16}/></button>
                                                <button onClick={() => handleDelete(d.id)} className="text-red-600 hover:text-red-800 mx-1"><Icon name="trash-2" size={16}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )
            };

            const DemandForm = () => {
                const [data, setData] = useState(currentDemand?.id ? currentDemand : {
                    refNumber: '', entryDate: new Date().toISOString().split('T')[0], status: 'Pendente',
                    project: '', value: 0, approvedValue: 0, counterpartCompliance: '', evidenceLink: ''
                });

                const handleChange = (e) => setData({ ...data, [e.target.name]: e.target.value });

                return (
                    <div className="bg-white rounded shadow-lg max-w-4xl mx-auto overflow-hidden">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="shield" size={18}/> Registro Seguro</h3>
                            <button onClick={()=>setView('list')} className="text-slate-400 hover:text-white"><Icon name="x"/></button>
                        </div>
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="col-span-2 bg-yellow-50 border-l-4 border-yellow-400 p-3 text-xs text-yellow-800">
                                <strong>Aviso de Auditoria:</strong> Todas as alterações neste formulário são registradas com timestamp do servidor e ID do usuário.
                            </div>
                            
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Nº Ofício *</label><input required name="refNumber" value={data.refNumber} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Data *</label><input type="date" required name="entryDate" value={data.entryDate} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-slate-500 mb-1">Projeto Vinculado</label>
                                <input list="projs" name="project" value={data.project} onChange={handleChange} className="w-full border p-2 rounded" placeholder="Selecione ou digite..."/>
                                <datalist id="projs"><option value="Reabilitação Rio Azul"/><option value="Educação Ambiental"/></datalist>
                            </div>

                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Valor Solicitado</label><input type="number" name="value" value={data.value} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="block text-xs font-bold text-emerald-700 mb-1">Valor Aprovado (R$)</label><input type="number" name="approvedValue" value={data.approvedValue} onChange={handleChange} className="w-full border p-2 rounded bg-emerald-50 border-emerald-200"/></div>

                            <div className="col-span-2 bg-slate-50 p-4 rounded border border-slate-200">
                                <label className="block text-xs font-bold text-slate-500 mb-1">Link de Evidência (Drive/SharePoint)</label>
                                <input type="url" name="evidenceLink" value={data.evidenceLink} onChange={handleChange} className="w-full border p-2 rounded text-blue-600 mb-3" placeholder="https://..."/>
                                
                                <label className="block text-xs font-bold text-slate-500 mb-1">Cumpriu Contrapartida?</label>
                                <select name="counterpartCompliance" value={data.counterpartCompliance} onChange={handleChange} className="w-full border p-2 rounded">
                                    <option value="">Selecione...</option><option value="Sim">Sim</option><option value="Não">Não</option>
                                </select>
                                {data.counterpartCompliance === 'Não' && <p className="text-xs text-red-600 mt-1 font-bold">Justificativa obrigatória para auditoria.</p>}
                            </div>

                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Status</label><select name="status" value={data.status} onChange={handleChange} className="w-full border p-2 rounded"><option>Pendente</option><option>Em execução</option><option>Concluída</option><option>Indeferida</option></select></div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Responsável</label><input name="assignee" value={data.assignee || ''} onChange={handleChange} className="w-full border p-2 rounded"/></div>

                            <div className="col-span-2 pt-4 border-t flex justify-end gap-3">
                                <button onClick={()=>setView('list')} className="px-4 py-2 border rounded hover:bg-slate-50 text-sm">Cancelar</button>
                                <button onClick={()=>handleSave(data)} className="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 text-sm font-bold flex items-center gap-2"><Icon name="save" size={16}/> Salvar Registro Seguro</button>
                            </div>

                            {/* Trilha de Auditoria Visual (Somente Leitura) */}
                            {data.auditTrail && (
                                <div className="col-span-2 mt-4 bg-slate-900 text-slate-300 p-3 rounded text-xs font-mono h-32 overflow-y-auto">
                                    <p className="text-emerald-400 font-bold border-b border-slate-700 mb-2 pb-1">LOG DE AUDITORIA DO SISTEMA</p>
                                    {data.auditTrail.map((log, i) => (
                                        <div key={i} className="mb-1">
                                            [{new Date(log.date).toLocaleString()}] {log.user} :: {log.action}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Se não autenticado, mostra login. Se autenticado, mostra sistema.
            if (!user) return <LoginScreen onLogin={() => {}} loading={authLoading} />; // A lógica de login real roda no useEffect

            return (
                <div className="flex min-h-screen">
                    <aside className="w-64 bg-slate-900 text-white hidden md:flex flex-col">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-xl font-bold tracking-widest text-emerald-500">SIS-ESG</h1><p className="text-[10px] text-slate-500 mt-1">AMBIENTE SEGURO v2.0</p></div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setView('dashboard')} className={`w-full text-left px-4 py-3 rounded flex gap-3 ${view==='dashboard'?'bg-emerald-600':'hover:bg-slate-800'}`}><Icon name="pie-chart"/> Dashboard</button>
                            <button onClick={()=>setView('list')} className={`w-full text-left px-4 py-3 rounded flex gap-3 ${view==='list'?'bg-emerald-600':'hover:bg-slate-800'}`}><Icon name="folder-open"/> Demandas</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-xs text-slate-500">Logado como:<br/><span className="text-white">{user.uid.substring(0,10)}...</span></div>
                    </aside>
                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="md:hidden bg-white p-4 shadow-sm flex justify-between"><span className="font-bold">SIS-ESG</span><button onClick={()=>setMobileMenuOpen(!mobileMenuOpen)}><Icon name="menu"/></button></header>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {view === 'dashboard' && <Dashboard />}
                            {view === 'list' && <DemandList />}
                            {view === 'form' && <DemandForm />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
